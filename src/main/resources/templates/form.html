<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Plan - Retro Macros</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}" />
</head>
<body class="neon">
<div th:replace="~{fragments/navbar :: authenticated-navbar}"></div>

<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <h1 class="mb-4 section-title">Create Your Plan</h1>

            <!-- Error Alert -->
            <div th:if="${errors}" class="alert alert-danger">
                <ul class="mb-0">
                    <li th:each="e : ${errors}" th:text="${e}"></li>
                </ul>
            </div>

            <form th:action="@{/generate}" method="post" class="needs-validation" id="mealPlanForm" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- Personal Metrics Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">Personal Metrics</h3>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="weight" class="form-label">Weight (lbs)</label>
                                <input type="number" class="form-control" id="weight" name="weight"
                                       placeholder="e.g., 180" min="50" max="500" step="1" required
                                       th:value="${param.weight}">
                                <div class="invalid-feedback">Please enter a valid weight (50-500 lbs).</div>
                            </div>

                            <div class="col-md-2">
                                <label for="heightFeet" class="form-label">Height (feet)</label>
                                <input type="number" class="form-control" id="heightFeet" name="heightFeet"
                                       placeholder="e.g., 5" min="3" max="8" required th:value="${param.heightFeet}">
                                <div class="invalid-feedback">Enter feet between 3 and 8.</div>
                            </div>

                            <div class="col-md-2">
                                <label for="heightInches" class="form-label">Height (inches)</label>
                                <input type="number" class="form-control" id="heightInches" name="heightInches"
                                       placeholder="e.g., 10" min="0" max="11" required th:value="${param.heightInches}">
                                <div class="invalid-feedback">Enter inches between 0 and 11.</div>
                            </div>

                            <div class="col-md-2">
                                <label for="age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="age" name="age"
                                       placeholder="e.g., 30" min="13" max="100" required th:value="${param.age}">
                                <div class="invalid-feedback">Please enter a valid age (13-100).</div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Sex</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sex" id="sexMale"
                                               value="Male" required th:checked="${param.sex}=='Male'">
                                        <label class="form-check-label" for="sexMale">Male</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sex" id="sexFemale"
                                               value="Female" required th:checked="${param.sex}=='Female'">
                                        <label class="form-check-label" for="sexFemale">Female</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Level Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">Activity Level</h3>
                        <div class="row row-cols-1 row-cols-md-2 g-3">
                            <div class="col" th:each="lvl : ${activityLevels}">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="activityLevel"
                                           th:id="${'act-'+lvl}" th:value="${lvl}" required
                                           th:checked="${param.activityLevel}==${lvl}">
                                    <label class="form-check-label" th:for="${'act-'+lvl}" th:text="${lvl}"></label>
                                    <div class="form-text text-muted" th:switch="${lvl}">
                                        <small th:case="'Sedentary'">Desk job, little to no exercise</small>
                                        <small th:case="'Occasionally Active'">Light exercise 1–2 days/week</small>
                                        <small th:case="'Moderately Active'">Moderate exercise 3–5 days/week</small>
                                        <small th:case="'Very Active'">Hard exercise 6–7 days/week</small>
                                        <small th:case="*">Select the option that best matches your week</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BMR Calculation Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">BMR Calculation</h3>
                        <div class="mb-3">
                            <label class="form-label">BMR Calculation Formula</label>
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select" name="bmrFormula" id="bmrFormula" required>
                                    <option value="mifflin-st-jeor" selected>
                                        Mifflin-St Jeor (Recommended)
                                    </option>
                                    <option value="harris-benedict">Harris-Benedict (Classic)</option>
                                    <option value="katch-mcardle">
                                        Katch-McArdle (For athletes with known body fat %)
                                    </option>
                                </select>
                                <button type="button" class="btn btn-outline-neon btn-sm"
                                        data-bs-toggle="modal" data-bs-target="#formulaInfoModal">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Selecting Katch-McArdle requires your body fat percentage.
                            </small>
                        </div>
                        <div class="mb-3" id="bodyFatField">
                            <label class="form-label">
                                Body Fat Percentage <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" name="bodyFatPercentage" id="bodyFatPercentage"
                                   min="5" max="50" step="0.1" placeholder="e.g., 18.5">
                            <small class="form-text text-muted">
                                Required for Katch-McArdle. If you don't know your body fat %, choose a different formula.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Fitness Goal Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">Fitness Goal</h3>
                        <div class="d-flex flex-wrap gap-4" th:with="sel=${param.fitnessGoal}">
                            <div class="form-check" th:each="g : ${goals}">
                                <input class="form-check-input" type="radio" name="fitnessGoal"
                                       th:id="${'goal-'+g}" th:value="${g}" required th:checked="${sel}==${g}">
                                <label class="form-check-label" th:for="${'goal-'+g}" th:text="${g}"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Macro Split Customizer Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">Customize Your Macro Split</h3>

                        <div class="alert alert-success mb-3" id="recommendedAlert" style="display: none;">
                            <i class="bi bi-check-circle"></i>
                            <strong>Recommended for <span id="recommendedGoal">your goal</span>:</strong>
                            <span id="recommendedSplit">30% Protein, 40% Carbs, 30% Fat</span>
                        </div>

                        <div class="card p-4" style="background-color: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.3);">
                            <!-- Protein Slider -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="mb-0"><strong>Protein</strong></label>
                                    <span class="badge bg-primary"
                                          style="font-size: 1rem; padding: 0.5rem 1rem;">
                                        <span id="proteinPercentValue">30</span>%
                                    </span>
                                </div>
                                <input type="range" class="form-range" id="proteinPercent" name="proteinPercent"
                                       min="20" max="50" value="30" step="5" oninput="updateMacroSplit()">
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-primary protein-bar" id="proteinBar"
                                         role="progressbar" style="width: 30%" aria-valuenow="30"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <!-- Carbs Slider -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="mb-0"><strong>Carbs</strong></label>
                                    <span class="badge bg-warning text-dark"
                                          style="font-size: 1rem; padding: 0.5rem 1rem;">
                                        <span id="carbsPercentValue">40</span>%
                                    </span>
                                </div>
                                <input type="range" class="form-range" id="carbsPercent" name="carbsPercent"
                                       min="20" max="60" value="40" step="5" oninput="updateMacroSplit()">
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-warning carbs-bar" id="carbsBar"
                                         role="progressbar" style="width: 40%" aria-valuenow="40"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <!-- Fat Slider -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="mb-0"><strong>Fat</strong></label>
                                    <span class="badge bg-danger"
                                          style="font-size: 1rem; padding: 0.5rem 1rem;">
                                        <span id="fatPercentValue">30</span>%
                                    </span>
                                </div>
                                <input type="range" class="form-range" id="fatPercent" name="fatPercent"
                                       min="15" max="45" value="30" step="5" oninput="updateMacroSplit()">
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-danger fat-bar" id="fatBar"
                                         role="progressbar" style="width: 30%" aria-valuenow="30"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <!-- Total Validation -->
                            <div class="alert alert-success mb-3" id="totalAlert" role="alert">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Total: <span id="totalPercent">100</span>%</strong>
                                    <span id="totalMessage">Perfect!</span>
                                </div>
                            </div>

                            <button type="button" class="btn btn-outline-neon btn-sm" onclick="resetToRecommended()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Recommended
                            </button>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">
                            <i class="bi bi-info-circle"></i> Adjust the sliders to customize your macro split.
                            The total must equal 100%.
                        </small>
                    </div>
                </div>

                <!-- Allergies & Restrictions Card -->
                <div class="card neon mb-4">
                    <div class="card-body">
                        <h3 class="card-title section-title mb-3">Allergies & Restrictions</h3>
                        <div class="d-flex flex-wrap gap-4">
                            <div class="form-check" th:each="a : ${allergyOptions}">
                                <input class="form-check-input" type="checkbox" name="allergies"
                                       th:id="${'alg-'+a}" th:value="${a}"
                                       th:checked="${param.allergies != null and #lists.contains(param.allergies, a)}">
                                <label class="form-check-label" th:for="${'alg-'+a}" th:text="${a}"></label>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="otherAllergies" class="form-label">Other (comma-separated)</label>
                            <textarea id="otherAllergies" name="otherAllergies" class="form-control" rows="2"
                                      placeholder="e.g., tomatoes, bell peppers, lactose"
                                      th:text="${param.otherAllergies}"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button id="submitBtn" type="submit" class="btn btn-neon btn-lg">
                        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        <span>Generate My Meal Plan</span>
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script>
    // Bootstrap client-side validation
    (function () {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    const btn = document.getElementById('submitBtn');
                    if (btn) {
                        const spin = btn.querySelector('.spinner-border');
                        if (spin) spin.classList.remove('d-none');
                        btn.setAttribute('disabled', 'true');
                    }
                    form.classList.add('was-validated');
                }, false);
            });
    })();

    // Show/hide body fat field based on formula selection
    (function() {
        const sel = document.getElementById('bmrFormula');
        const field = document.getElementById('bodyFatField');
        const input = document.getElementById('bodyFatPercentage');
        function update() {
            if (sel && sel.value === 'katch-mcardle') {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
            }
        }
        if (sel) {
            sel.addEventListener('change', update);
            sel.addEventListener('input', update);
            update();
        }
    })();
</script>
<script th:src="@{/js/macro-sliders.js}"></script>

<!-- Formula Information Modal -->
<div class="modal fade" id="formulaInfoModal" tabindex="-1"
     aria-labelledby="formulaInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content neon">
            <div class="modal-header">
                <h5 class="modal-title" id="formulaInfoModalLabel">BMR Formulas Explained</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>Mifflin-St Jeor (Recommended)</h6>
                    <p>The most accurate formula for the general population. Developed in 1990 and widely validated by research.</p>
                    <p class="mb-0">
                        <strong>Best for:</strong> Most people, everyday use<br>
                        <strong>Requires:</strong> Age, gender, weight, height
                    </p>
                </div>
                <hr>
                <div class="mb-4">
                    <h6>Harris-Benedict (Revised)</h6>
                    <p>The classic formula, originally created in 1919 and revised in 1984. Reliable and widely recognized.</p>
                    <p class="mb-0">
                        <strong>Best for:</strong> Those familiar with this formula<br>
                        <strong>Requires:</strong> Age, gender, weight, height
                    </p>
                </div>
                <hr>
                <div class="mb-4">
                    <h6>Katch-McArdle</h6>
                    <p>Uses lean body mass (weight minus fat). Most accurate if you know your body fat percentage.</p>
                    <p class="mb-0">
                        <strong>Best for:</strong> Athletes and those with accurate body fat measurements<br>
                        <strong>Requires:</strong> Weight, body fat percentage
                    </p>
                </div>
                <hr>
                <div class="alert alert-success mb-0">
                    <strong>Not sure which to choose?</strong> Stick with Mifflin-St Jeor.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
