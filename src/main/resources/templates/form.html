<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Retro Macros - Input</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}" />
</head>
<body class="neon">
<div th:replace="~{fragments/navbar :: authenticated-navbar}"></div>

<div class="container mb-5">
    <div th:if="${errors}" class="alert alert-danger">
        <ul class="mb-0">
            <li th:each="e : ${errors}" th:text="${e}"></li>
        </ul>
    </div>

    <form th:action="@{/generate}" method="post" class="needs-validation" id="mealPlanForm" novalidate>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="row g-3">
            <div class="col-12">
                <h4 class="mb-3 section-title">Personal Metrics</h4>
            </div>

            <div class="col-md-3">
                <label for="weight" class="form-label">Weight (lbs)</label>
                <input type="number" class="form-control" id="weight" name="weight" placeholder="e.g., 180" min="50" max="500" step="1" required th:value="${param.weight}">
                <div class="invalid-feedback">Please enter a valid weight (50-500 lbs).</div>
            </div>

            <div class="col-md-2">
                <label for="heightFeet" class="form-label">Height (feet)</label>
                <input type="number" class="form-control" id="heightFeet" name="heightFeet" placeholder="e.g., 5" min="3" max="8" required th:value="${param.heightFeet}">
                <div class="invalid-feedback">Enter feet between 3 and 8.</div>
            </div>

            <div class="col-md-2">
                <label for="heightInches" class="form-label">Height (inches)</label>
                <input type="number" class="form-control" id="heightInches" name="heightInches" placeholder="e.g., 10" min="0" max="11" required th:value="${param.heightInches}">
                <div class="invalid-feedback">Enter inches between 0 and 11.</div>
            </div>

            <div class="col-md-2">
                <label for="age" class="form-label">Age</label>
                <input type="number" class="form-control" id="age" name="age" placeholder="e.g., 30" min="13" max="100" required th:value="${param.age}">
                <div class="invalid-feedback">Please enter a valid age (13-100).</div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Sex</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sex" id="sexMale" value="Male" required th:checked="${param.sex}=='Male'">
                        <label class="form-check-label" for="sexMale">Male</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sex" id="sexFemale" value="Female" required th:checked="${param.sex}=='Female'">
                        <label class="form-check-label" for="sexFemale">Female</label>
                    </div>
                </div>
            </div>

            <div class="col-12 mt-4">
                <h4 class="mb-3 section-title">Activity Level</h4>
                <div class="row row-cols-1 row-cols-md-2 g-3">
                    <div class="col" th:each="lvl : ${activityLevels}">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="activityLevel" th:id="${'act-'+lvl}" th:value="${lvl}" required th:checked="${param.activityLevel}==${lvl}">
                            <label class="form-check-label" th:for="${'act-'+lvl}" th:text="${lvl}"></label>
                            <div class="form-text text-muted" th:switch="${lvl}">
                                <small th:case="'Sedentary'">Desk job, little to no exercise</small>
                                <small th:case="'Occasionally Active'">Light exercise 1‚Äì2 days/week</small>
                                <small th:case="'Moderately Active'">Moderate exercise 3‚Äì5 days/week</small>
                                <small th:case="'Very Active'">Hard exercise 6‚Äì7 days/week</small>
                                <small th:case="*">Select the option that best matches your week</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BMR Formula selection -->
            <div class="col-12 mt-4">
                <h4 class="mb-3 section-title">BMR Calculation</h4>
                <div class="mb-3">
                    <label class="form-label">BMR Calculation Formula</label>
                    <select class="form-select" name="bmrFormula" id="bmrFormula" required>
                        <option value="mifflin-st-jeor" selected>Mifflin-St Jeor (Recommended) ‚≠ê</option>
                        <option value="harris-benedict">Harris-Benedict (Classic)</option>
                        <option value="katch-mcardle">Katch-McArdle (For athletes with known body fat %)</option>
                    </select>
                    <small class="form-text text-muted">Selecting Katch-McArdle requires your body fat percentage.</small>
                </div>
                <div class="mb-3" id="bodyFatField">
                    <label class="form-label">Body Fat Percentage <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" name="bodyFatPercentage" id="bodyFatPercentage" min="5" max="50" step="0.1" placeholder="e.g., 18.5">
                    <small class="form-text text-muted">Required for Katch-McArdle. If you don't know your body fat %, choose a different formula.</small>
                </div>
            </div>

            <div class="col-12 mt-4">
                <h4 class="mb-3 section-title">Fitness Goal</h4>
                <div class="d-flex flex-wrap gap-4" th:with="sel=${param.fitnessGoal}">
                    <div class="form-check" th:each="g : ${goals}">
                        <input class="form-check-input" type="radio" name="fitnessGoal" th:id="${'goal-'+g}" th:value="${g}" required th:checked="${sel}==${g}">
                        <label class="form-check-label" th:for="${'goal-'+g}" th:text="${g}"></label>
                    </div>
                </div>
            </div>

            <!-- Macro Split Customizer -->
            <div class="col-12 mt-4">
                <h4 class="mb-3 section-title">Customize Your Macro Split</h4>
                <div class="alert alert-success mb-3" id="recommendedAlert" style="display: none;">
                    <i class="bi bi-check-circle"></i>
                    <strong>Recommended for <span id="recommendedGoal">your goal</span>:</strong>
                    <span id="recommendedSplit">30% Protein, 40% Carbs, 30% Fat</span>
                </div>

                <div class="card p-4" style="background-color: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.3);">
                    <!-- Protein Slider -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">üí™ <strong>Protein</strong></label>
                            <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;"><span id="proteinPercentValue">30</span>%</span>
                        </div>
                        <input type="range" class="form-range" id="proteinPercent" name="proteinPercent" min="20" max="50" value="30" step="5" oninput="updateMacroSplit()">
                        <div class="progress" style="height: 10px;"><div class="progress-bar bg-primary" id="proteinBar" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div></div>
                    </div>

                    <!-- Carbs Slider -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">üçö <strong>Carbs</strong></label>
                            <span class="badge bg-warning text-dark" style="font-size: 1rem; padding: 0.5rem 1rem;"><span id="carbsPercentValue">40</span>%</span>
                        </div>
                        <input type="range" class="form-range" id="carbsPercent" name="carbsPercent" min="20" max="60" value="40" step="5" oninput="updateMacroSplit()">
                        <div class="progress" style="height: 10px;"><div class="progress-bar bg-warning" id="carbsBar" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div></div>
                    </div>

                    <!-- Fat Slider -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">ü•ë <strong>Fat</strong></label>
                            <span class="badge bg-danger" style="font-size: 1rem; padding: 0.5rem 1rem;"><span id="fatPercentValue">30</span>%</span>
                        </div>
                        <input type="range" class="form-range" id="fatPercent" name="fatPercent" min="15" max="45" value="30" step="5" oninput="updateMacroSplit()">
                        <div class="progress" style="height: 10px;"><div class="progress-bar bg-danger" id="fatBar" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div></div>
                    </div>

                    <!-- Total Validation -->
                    <div class="alert alert-success mb-3" id="totalAlert" role="alert">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total: <span id="totalPercent">100</span>%</strong>
                            <span id="totalMessage">‚úì Perfect!</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-neon btn-sm" onclick="resetToRecommended()"><i class="bi bi-arrow-counterclockwise"></i> Reset to Recommended</button>
                </div>
                <small class="form-text text-muted mt-2 d-block"><i class="bi bi-info-circle"></i> Adjust the sliders to customize your macro split. The total must equal 100%.</small>
            </div>
            <div class="col-12 mt-4">
                <h4 class="mb-3 section-title">Allergies & Restrictions</h4>
                <div class="d-flex flex-wrap gap-4">
                    <div class="form-check" th:each="a : ${allergyOptions}">
                        <input class="form-check-input" type="checkbox" name="allergies" th:id="${'alg-'+a}" th:value="${a}"
                               th:checked="${param.allergies != null and #lists.contains(param.allergies, a)}">
                        <label class="form-check-label" th:for="${'alg-'+a}" th:text="${a}"></label>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="otherAllergies" class="form-label">Other (comma-separated)</label>
                    <textarea id="otherAllergies" name="otherAllergies" class="form-control" rows="2" placeholder="e.g., tomatoes, bell peppers, lactose" th:text="${param.otherAllergies}"></textarea>
                </div>
            </div>

            <div class="col-12 mt-4">
                <button id="submitBtn" type="submit" class="btn btn-neon btn-lg">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    <span>Generate My Meal Plan</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script>
    // Bootstrap client-side validation
    (function () {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    const btn = document.getElementById('submitBtn')
                    if (btn) {
                        const spin = btn.querySelector('.spinner-border')
                        if (spin) spin.classList.remove('d-none')
                        btn.setAttribute('disabled', 'true')
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()

    // Show/hide body fat field based on formula selection
    (function() {
        const sel = document.getElementById('bmrFormula');
        const field = document.getElementById('bodyFatField');
        const input = document.getElementById('bodyFatPercentage');
        function update() {
            if (sel && sel.value === 'katch-mcardle') {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
            }
        }
        if (sel) {
            sel.addEventListener('change', update);
            sel.addEventListener('input', update);
            update();
        }
    })();

    // Macro split interactions
    function currentGoalValue() {
        const checked = document.querySelector('input[name="fitnessGoal"]:checked');
        return checked ? checked.value : '';
    }

    function updateRecommendedBanner() {
        const g = (currentGoalValue() || '').toLowerCase();
        const alertEl = document.getElementById('recommendedAlert');
        if (!alertEl) return;
        // Hide when no goal selected
        if (!g) {
            alertEl.style.display = 'none';
            return;
        }
        // Compute text based on goal
        let recText = '30% Protein, 40% Carbs, 30% Fat';
        let goalText = 'your goal';
        if (g.includes('lose')) { recText = '35% Protein, 35% Carbs, 30% Fat'; goalText = 'losing weight'; }
        else if (g.includes('build')) { recText = '30% Protein, 45% Carbs, 25% Fat'; goalText = 'building muscle'; }
        else if (g.includes('maintain')) { recText = '30% Protein, 40% Carbs, 30% Fat'; goalText = 'maintaining weight'; }
        const rg = document.getElementById('recommendedGoal'); if (rg) rg.textContent = goalText;
        const rs = document.getElementById('recommendedSplit'); if (rs) rs.textContent = recText;
        // Show after updating
        alertEl.style.display = 'block';
    }

    function updateMacroSplit() {
        const protein = parseInt(document.getElementById('proteinPercent').value);
        const carbs = parseInt(document.getElementById('carbsPercent').value);
        const fat = parseInt(document.getElementById('fatPercent').value);

        document.getElementById('proteinPercentValue').textContent = protein;
        document.getElementById('carbsPercentValue').textContent = carbs;
        document.getElementById('fatPercentValue').textContent = fat;

        document.getElementById('proteinBar').style.width = protein + '%';
        document.getElementById('proteinBar').setAttribute('aria-valuenow', protein);
        document.getElementById('carbsBar').style.width = carbs + '%';
        document.getElementById('carbsBar').setAttribute('aria-valuenow', carbs);
        document.getElementById('fatBar').style.width = fat + '%';
        document.getElementById('fatBar').setAttribute('aria-valuenow', fat);

        const total = protein + carbs + fat;
        document.getElementById('totalPercent').textContent = total;
        const alertDiv = document.getElementById('totalAlert');
        const msg = document.getElementById('totalMessage');
        if (total === 100) {
            alertDiv.className = 'alert alert-success mb-3';
            msg.innerHTML = '<i class="bi bi-check-circle-fill"></i> Perfect!';
        } else if (total < 100) {
            alertDiv.className = 'alert alert-warning mb-3';
            msg.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Need ' + (100 - total) + '% more';
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            msg.innerHTML = '<i class="bi bi-x-circle-fill"></i> Reduce by ' + (total - 100) + '%';
        }
    }

    function resetToRecommended() {
        const g = (currentGoalValue() || '').toLowerCase();
        let p=30,c=40,f=30;
        if (g.includes('lose')) { p=35; c=35; f=30; }
        else if (g.includes('build')) { p=30; c=45; f=25; }
        else if (g.includes('maintain')) { p=30; c=40; f=30; }
        document.getElementById('proteinPercent').value = p;
        document.getElementById('carbsPercent').value = c;
        document.getElementById('fatPercent').value = f;
        updateMacroSplit();
    }

    // Update banner on goal change
    document.querySelectorAll('input[name="fitnessGoal"]').forEach(r => {
        r.addEventListener('change', () => {
            updateRecommendedBanner();
            resetToRecommended();
        })
    });

    // Validate on submit: total must be 100
    document.getElementById('mealPlanForm').addEventListener('submit', function(e) {
        const total = parseInt(document.getElementById('proteinPercent').value) +
                      parseInt(document.getElementById('carbsPercent').value) +
                      parseInt(document.getElementById('fatPercent').value);
        if (total !== 100) {
            e.preventDefault();
            alert('Macro percentages must total 100%. Current total: ' + total + '%');
            document.getElementById('proteinPercent').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function(){ updateRecommendedBanner(); updateMacroSplit(); });
</script>

<!-- Formula Information Modal -->
<div class="modal fade" id="formulaInfoModal" tabindex="-1" aria-labelledby="formulaInfoModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content neon">
    <div class="modal-header"><h5 class="modal-title" id="formulaInfoModalLabel">BMR Formulas Explained</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
    <div class="modal-body">
        <div class="mb-4">
            <h6>‚≠ê Mifflin-St Jeor (Recommended)</h6>
            <p>The most accurate formula for the general population. Developed in 1990 and widely validated by research.</p>
            <p class="mb-0"><strong>Best for:</strong> Most people, everyday use<br><strong>Requires:</strong> Age, gender, weight, height</p>
        </div>
        <hr>
        <div class="mb-4">
            <h6>Harris-Benedict (Revised)</h6>
            <p>The classic formula, originally created in 1919 and revised in 1984. Reliable and widely recognized.</p>
            <p class="mb-0"><strong>Best for:</strong> Those familiar with this formula<br><strong>Requires:</strong> Age, gender, weight, height</p>
        </div>
        <hr>
        <div class="mb-4">
            <h6>Katch-McArdle</h6>
            <p>Uses lean body mass (weight minus fat). Most accurate if you know your body fat percentage.</p>
            <p class="mb-0"><strong>Best for:</strong> Athletes and those with accurate body fat measurements<br><strong>Requires:</strong> Weight, body fat percentage</p>
        </div>
        <hr>
        <div class="alert alert-success mb-0"><strong>Not sure which to choose?</strong> Stick with Mifflin-St Jeor.</div>
    </div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
</div></div></div>
</body>
</html>
