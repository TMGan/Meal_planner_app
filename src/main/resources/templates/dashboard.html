<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Retro Macros</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="neon">
<div th:replace="~{fragments/navbar :: authenticated-navbar}"></div>

<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <!-- Page Title -->
            <h1 class="mb-4 section-title">Dashboard</h1>

            <!-- Welcome Card -->
            <div class="card neon mb-4">
                <div class="card-body">
                    <h3 class="card-title section-title">Welcome, <span th:text="${user.name}">User</span>!</h3>
                    <p class="text-muted mb-0">Track your macros and stay on target.</p>
                </div>
            </div>

            <!-- My Food Preferences Card -->
            <div class="card neon mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="card-title section-title mb-0">
                            <i class="bi bi-emoji-smile me-2"></i>My Food Preferences
                        </h3>
                        <button class="btn btn-sm btn-outline-neon" data-bs-toggle="modal" data-bs-target="#preferencesModal">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                    </div>

                    <div th:if="${userPreferences != null}">
                        <div class="mb-3">
                            <strong>Foods I Like:</strong>
                            <div class="mt-2">
                                <span class="badge text-bg-success me-2"
                                      th:each="food : ${#strings.arraySplit(userPreferences.preferredFoodsText, ',')}">
                                    <span th:text="${#strings.trim(food)}">Chicken breast</span>
                                </span>
                            </div>
                        </div>

                        <div th:if="${userPreferences.avoidedFoodsText != null && !#strings.isEmpty(userPreferences.avoidedFoodsText)}">
                            <strong>Foods to Avoid:</strong>
                            <div class="mt-2">
                                <span class="badge text-bg-danger me-2"
                                      th:each="food : ${#strings.arraySplit(userPreferences.avoidedFoodsText, ',')}">
                                    <span th:text="${#strings.trim(food)}">Brown rice</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${userPreferences == null}">
                        <p class="text-muted mb-2">Set your food preferences to get more personalized meal plans!</p>
                        <button class="btn btn-neon" data-bs-toggle="modal" data-bs-target="#preferencesModal">Set Preferences</button>
                    </div>
                </div>
            </div>

            <!-- Today's Progress Card -->
            <div class="card neon mb-4">
                <div class="card-body">
                    <h3 class="card-title section-title mb-4">Today's Progress</h3>
                    <div th:if="${latestPlan != null}">
                        <p class="text-muted">Your daily targets (from latest meal plan):</p>
                        <div class="row text-center mb-4">
                            <div class="col-3">
                                <h3 th:text="${latestPlan.targetCalories}">0</h3>
                                <small>Calories</small>
                            </div>
                            <div class="col-3">
                                <h3 th:text="${latestPlan.targetProtein + 'g'}">0g</h3>
                                <small>Protein</small>
                            </div>
                            <div class="col-3">
                                <h3 th:text="${latestPlan.targetCarbs + 'g'}">0g</h3>
                                <small>Carbs</small>
                            </div>
                            <div class="col-3">
                                <h3 th:text="${latestPlan.targetFat + 'g'}">0g</h3>
                                <small>Fat</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5>
                                Calories:
                                <span th:text="${todaysTotals.calories}">0</span>
                                /
                                <span th:text="${latestPlan.targetCalories}">0</span>
                            </h5>
                            <div class="progress" style="height:25px;">
                                <div class="progress-bar bg-info" role="progressbar"
                                     th:style="${'width:' + (latestPlan.targetCalories > 0 ? (todaysTotals.calories * 100 / latestPlan.targetCalories) : 0) + '%'}">
                                    <span th:text="${#numbers.formatDecimal(latestPlan.targetCalories > 0 ? (todaysTotals.calories * 100.0 / latestPlan.targetCalories) : 0,0,0)} + '%'">
                                        0%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <h6>
                                    Protein:
                                    <span th:text="${todaysTotals.protein}">0</span>g
                                    /
                                    <span th:text="${latestPlan.targetProtein}">0</span>g
                                </h6>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" role="progressbar"
                                         th:style="${'width:' + (latestPlan.targetProtein > 0 ? (todaysTotals.protein * 100 / latestPlan.targetProtein) : 0) + '%'}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6>
                                    Carbs:
                                    <span th:text="${todaysTotals.carbs}">0</span>g
                                    /
                                    <span th:text="${latestPlan.targetCarbs}">0</span>g
                                </h6>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar"
                                         th:style="${'width:' + (latestPlan.targetCarbs > 0 ? (todaysTotals.carbs * 100 / latestPlan.targetCarbs) : 0) + '%'}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6>
                                    Fat:
                                    <span th:text="${todaysTotals.fat}">0</span>g
                                    /
                                    <span th:text="${latestPlan.targetFat}">0</span>g
                                </h6>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         th:style="${'width:' + (latestPlan.targetFat > 0 ? (todaysTotals.fat * 100 / latestPlan.targetFat) : 0) + '%'}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${latestPlan == null}">
                        <p class="text-muted mb-0">No recent saved plan found. Generate a plan first.</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions + Recent Food Logs -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card neon h-100">
                        <div class="card-body">
                            <h3 class="card-title section-title mb-3">
                                <i class="bi bi-journal-text me-2"></i>Quick Actions
                            </h3>
                            <p class="text-muted">Jump into the most common actions.</p>
                            <div class="d-grid gap-2">
                                <a href="/form" class="btn btn-neon">
                                    <i class="bi bi-plus-circle"></i> Create New Plan
                                </a>
                                <a href="/my-plans" class="btn btn-outline-neon">
                                    <i class="bi bi-collection"></i> View My Plans
                                </a>
                                <a href="/food-log-history" class="btn btn-outline-neon">
                                    <i class="bi bi-clock-history"></i> 7-Day Food Log History
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card neon h-100">
                        <div class="card-body">
                            <h3 class="card-title section-title mb-3">
                                <i class="bi bi-graph-up-arrow me-2"></i>Recent Food Logs
                            </h3>
                            <p class="text-muted">Your most recent entries:</p>
                            <div th:if="${recentLogs != null && !recentLogs.isEmpty()}">
                                <ul class="list-unstyled mb-0">
                                    <li th:each="log : ${recentLogs}" class="mb-2">
                                        <strong th:text="${log.mealName}">Meal</strong> -
                                        <span th:text="${log.calories}">0</span> cal,
                                        <span th:text="${log.protein}">0</span>g P,
                                        <span th:text="${log.carbs}">0</span>g C,
                                        <span th:text="${log.fat}">0</span>g F
                                        <small class="text-muted ms-2"
                                               th:text="${#temporals.format(log.timeLogged, 'MMM d, h:mm a')}">
                                            Time
                                        </small>
                                    </li>
                                </ul>
                            </div>
                            <div th:if="${recentLogs == null || recentLogs.isEmpty()}">
                                <p class="text-muted mb-0">No recent logs. Start tracking your meals!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Manual Add Modal -->
<div class="modal fade" id="manualAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content neon">
            <div class="modal-header">
                <h5 class="modal-title">Add Food Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/food-log/add" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="timezone" id="manualTimezone" value="" />
                    <input type="hidden" id="dailyTargetCalories"
                           th:value="${latestPlan != null ? latestPlan.targetCalories : 0}" />

                    <!-- Mode Selector -->
                    <div class="btn-group w-100 mb-4" role="group">
                        <button type="button" class="btn btn-outline-success active" id="suggestedModeBtn"
                                onclick="switchToSuggestedMode()">
                            <i class="bi bi-stars"></i> Suggested (Healthy)
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="manualModeBtn"
                                onclick="switchToManualMode()">
                            <i class="bi bi-pencil"></i> Manual Input
                        </button>
                    </div>

                    <!-- Suggested Mode Section -->
                    <div id="suggestedModeSection">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-lightbulb"></i>
                            We'll suggest a healthy meal that fits your macros. Don't like it?
                            Click <strong>Random</strong> for more ideas!
                        </div>
                        <div class="card neon mb-3" id="suggestionCard">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">Suggested Meal</h6>
                                    <button type="button" class="btn btn-sm btn-outline-neon"
                                            onclick="getRandomSuggestion()">
                                        <i class="bi bi-arrow-repeat"></i> Random
                                    </button>
                                </div>
                                <div id="suggestionContent" class="text-muted">
                                    Click Random to get a healthy meal suggestion...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Mode Section -->
                    <div id="manualModeSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">What did you eat?</label>
                            <textarea class="form-control" id="manualFoodDescription" rows="3"
                                      placeholder="e.g., Chipotle chicken bowl, Hot Pocket, leftover pizza, protein shake"></textarea>
                            <small class="form-text text-muted">
                                Enter anything - we'll estimate the macros
                            </small>
                        </div>
                        <button type="button" class="btn btn-primary mb-3" onclick="estimateFromManualInput(event)">
                            <i class="bi bi-calculator"></i> Estimate Macros
                        </button>
                        <div id="healthierAlternative" class="alert alert-success" style="display: none;">
                            <strong><i class="bi bi-lightbulb"></i> Healthier Alternative:</strong>
                            <p class="mb-0 mt-2" id="healthierAlternativeText"></p>
                            <small class="text-muted">Similar macros, whole food option</small>
                        </div>
                    </div>

                    <!-- Common Section: Meal Name -->
                    <div class="mb-3 mt-3">
                        <label class="form-label">Meal Name</label>
                        <select class="form-select" name="mealName" required>
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Snack">Snack</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Hidden Food Description to submit -->
                    <input type="hidden" id="finalFoodDescription" name="foodDescription" value="Custom food" />

                    <!-- Macro Inputs -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Calories</label>
                            <input type="number" class="form-control" id="calories" name="calories" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Protein (g)</label>
                            <input type="number" class="form-control" id="protein" name="protein" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Carbs (g)</label>
                            <input type="number" class="form-control" id="carbs" name="carbs" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fat (g)</label>
                            <input type="number" class="form-control" id="fat" name="fat" min="0" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Food</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Food Preferences Modal -->
<div class="modal fade" id="preferencesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content neon">
            <div class="modal-header">
                <h5 class="modal-title">My Food Preferences</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/preferences/save}" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <p class="text-muted mb-4">
                        Tell us what foods you like, and we'll use them when generating your meal plans.
                        Be as specific or general as you want!
                    </p>
                    <div class="mb-4">
                        <label class="form-label"><strong>Foods I Like / Want in My Meal Plans</strong></label>
                        <textarea class="form-control" name="preferredFoods" rows="5"
                                  placeholder="Examples:
- Proteins: chicken breast, salmon, eggs, ground turkey, protein shakes
- Carbs: white rice, oats, sweet potato, whole wheat bread
- Fats: avocado, olive oil, almonds
- Veggies: broccoli, spinach, peppers
- Other: Greek yogurt, bananas, protein bars"
                                  th:text="${userPreferences?.preferredFoodsText}"></textarea>
                        <small class="form-text text-muted">
                            List foods separated by commas. Be specific if you have preferences
                            (e.g., &quot;white rice not brown rice&quot;)
                        </small>
                    </div>
                    <div class="mb-4">
                        <label class="form-label"><strong>Foods to Avoid (Optional)</strong></label>
                        <textarea class="form-control" name="avoidedFoods" rows="3"
                                  placeholder="Examples: brown rice, quinoa, tofu, fish, mushrooms"
                                  th:text="${userPreferences?.avoidedFoodsText}"></textarea>
                        <small class="form-text text-muted">
                            Anything listed here will not be included in your meal plans.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Timezone detection for manual add modal
    document.addEventListener('DOMContentLoaded', function () {
        const tzField = document.getElementById('manualTimezone');
        if (tzField) {
            try {
                tzField.value = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            } catch (e) {
                tzField.value = '';
            }
        }
    });

    function switchToSuggestedMode() {
        document.getElementById('suggestedModeSection').style.display = '';
        document.getElementById('manualModeSection').style.display = 'none';
        document.getElementById('suggestedModeBtn').classList.add('active');
        document.getElementById('manualModeBtn').classList.remove('active');
    }

    function switchToManualMode() {
        document.getElementById('suggestedModeSection').style.display = 'none';
        document.getElementById('manualModeSection').style.display = '';
        document.getElementById('suggestedModeBtn').classList.remove('active');
        document.getElementById('manualModeBtn').classList.add('active');
    }

    async function getRandomSuggestion() {
        const dailyTarget = parseInt(document.getElementById('dailyTargetCalories')?.value || '0', 10);
        const alertContainer = document.getElementById('suggestionContent');
        if (!alertContainer) return;

        alertContainer.textContent = 'Generating suggestion...';

        try {
            const response = await fetch('/api/food-log/suggestion?targetCalories=' + encodeURIComponent(dailyTarget || 0), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (!response.ok) throw new Error('Request failed');
            const data = await response.json();
            alertContainer.innerHTML = data.description || 'No suggestion returned.';

            if (data.calories != null) document.getElementById('calories').value = data.calories;
            if (data.protein != null) document.getElementById('protein').value = data.protein;
            if (data.carbs != null) document.getElementById('carbs').value = data.carbs;
            if (data.fat != null) document.getElementById('fat').value = data.fat;

            document.getElementById('finalFoodDescription').value = data.description || 'Suggested meal';
        } catch (e) {
            alertContainer.textContent = 'Unable to get a suggestion right now. Please try again later.';
        }
    }

    async function estimateFromManualInput(event) {
        event.preventDefault();
        const desc = document.getElementById('manualFoodDescription')?.value || '';
        const target = parseInt(document.getElementById('dailyTargetCalories')?.value || '0', 10);
        if (!desc.trim()) {
            showAlert('Please describe what you ate first.', 'warning');
            return;
        }

        showAlert('Estimating macros from your description...', 'info');

        try {
            const response = await fetch('/api/food-log/estimate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ description: desc, targetCalories: target || null })
            });
            if (!response.ok) throw new Error('Request failed');
            const data = await response.json();

            if (data.calories != null) document.getElementById('calories').value = data.calories;
            if (data.protein != null) document.getElementById('protein').value = data.protein;
            if (data.carbs != null) document.getElementById('carbs').value = data.carbs;
            if (data.fat != null) document.getElementById('fat').value = data.fat;

            document.getElementById('finalFoodDescription').value = data.cleanedDescription || desc;

            if (data.healthierAlternative) {
                const alt = document.getElementById('healthierAlternative');
                const txt = document.getElementById('healthierAlternativeText');
                if (alt && txt) {
                    txt.textContent = data.healthierAlternative;
                    alt.style.display = '';
                }
            }

            showAlert('Macros estimated successfully. Review and adjust if needed, then save the entry.', 'success');
        } catch (e) {
            showAlert('Something went wrong while estimating macros. Please enter them manually.', 'danger');
        }
    }

    function showAlert(message, type) {
        const container = document.querySelector('#manualAddModal .modal-body');
        if (!container) return;
        const existing = container.querySelector('.alert');
        if (existing) existing.remove();
        const el = document.createElement('div');
        el.className = `alert alert-${type} alert-dismissible fade show`;
        el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.insertBefore(el, container.firstChild);
        setTimeout(() => el.remove(), 5000);
    }
</script>
</body>
</html>
