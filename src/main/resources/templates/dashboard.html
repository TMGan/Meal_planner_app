<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Retro Macros</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/theme.css}" />
    </head>
<body class="neon">
<div th:replace="~{fragments/navbar :: authenticated-navbar}"></div>

<div class="container my-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Welcome back, <span th:text="${user.name}">User</span>! ðŸ‘‹</h1>
            <p class="text-muted">Track your macros and stay on target.</p>
        </div>
    </div>

    <!-- My Food Preferences Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card neon"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="section-title mb-0"><i class="bi bi-emoji-smile me-2"></i>My Food Preferences</h3>
                    <button class="btn btn-sm btn-outline-neon" data-bs-toggle="modal" data-bs-target="#preferencesModal">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>

                <div th:if="${userPreferences != null}">
                    <div class="mb-3">
                        <strong>Foods I Like:</strong>
                        <div class="mt-2">
                            <span class="badge text-bg-success me-2" th:each="food : ${#strings.arraySplit(userPreferences.preferredFoodsText, ',')}">
                                <span th:text="${#strings.trim(food)}">Chicken breast</span>
                            </span>
                        </div>
                    </div>

                    <div th:if="${userPreferences.avoidedFoodsText != null && !#strings.isEmpty(userPreferences.avoidedFoodsText)}">
                        <strong>Foods to Avoid:</strong>
                        <div class="mt-2">
                            <span class="badge text-bg-danger me-2" th:each="food : ${#strings.arraySplit(userPreferences.avoidedFoodsText, ',')}">
                                <span th:text="${#strings.trim(food)}">Brown rice</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div th:if="${userPreferences == null}">
                    <p class="text-muted mb-2">Set your food preferences to get more personalized meal plans!</p>
                    <button class="btn btn-neon" data-bs-toggle="modal" data-bs-target="#preferencesModal">Set Preferences</button>
                </div>
            </div></div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card neon"><div class="card-body">
                <h2 class="card-title mb-4">Today's Progress</h2>
                <div th:if="${latestPlan != null}">
                    <p class="text-muted">Your daily targets (from latest meal plan):</p>
                    <div class="row text-center mb-4">
                        <div class="col-3"><h3 th:text="${latestPlan.targetCalories}">0</h3><small>Calories</small></div>
                        <div class="col-3"><h3 th:text="${latestPlan.targetProtein + 'g'}">0g</h3><small>Protein</small></div>
                        <div class="col-3"><h3 th:text="${latestPlan.targetCarbs + 'g'}">0g</h3><small>Carbs</small></div>
                        <div class="col-3"><h3 th:text="${latestPlan.targetFat + 'g'}">0g</h3><small>Fat</small></div>
                    </div>
                    <div class="mb-4">
                        <h5>Calories: <span th:text="${todaysTotals.calories}">0</span> / <span th:text="${latestPlan.targetCalories}">0</span></h5>
                        <div class="progress" style="height:25px;">
                            <div class="progress-bar bg-info" role="progressbar"
                                 th:style="${'width:' + (latestPlan.targetCalories > 0 ? (todaysTotals.calories * 100 / latestPlan.targetCalories) : 0) + '%'}">
                                <span th:text="${#numbers.formatDecimal(latestPlan.targetCalories > 0 ? (todaysTotals.calories * 100.0 / latestPlan.targetCalories) : 0,0,0)} + '%'">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <h6>Protein: <span th:text="${todaysTotals.protein}">0</span>g / <span th:text="${latestPlan.targetProtein}">0</span>g</h6>
                            <div class="progress"><div class="progress-bar bg-primary" role="progressbar"
                                 th:style="${'width:' + (latestPlan.targetProtein > 0 ? (todaysTotals.protein * 100 / latestPlan.targetProtein) : 0) + '%'}"></div></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h6>Carbs: <span th:text="${todaysTotals.carbs}">0</span>g / <span th:text="${latestPlan.targetCarbs}">0</span>g</h6>
                            <div class="progress"><div class="progress-bar bg-warning" role="progressbar"
                                 th:style="${'width:' + (latestPlan.targetCarbs > 0 ? (todaysTotals.carbs * 100 / latestPlan.targetCarbs) : 0) + '%'}"></div></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h6>Fat: <span th:text="${todaysTotals.fat}">0</span>g / <span th:text="${latestPlan.targetFat}">0</span>g</h6>
                            <div class="progress"><div class="progress-bar bg-danger" role="progressbar"
                                 th:style="${'width:' + (latestPlan.targetFat > 0 ? (todaysTotals.fat * 100 / latestPlan.targetFat) : 0) + '%'}"></div></div>
                        </div>
                    </div>
                </div>
                <div th:if="${latestPlan == null}">
                    <p class="text-muted">You haven't created a meal plan yet.</p>
                    <p><strong>Today's totals:</strong>
                        <span th:text="${todaysTotals.calories}">0</span> cal |
                        <span th:text="${todaysTotals.protein}">0</span>g P |
                        <span th:text="${todaysTotals.carbs}">0</span>g C |
                        <span th:text="${todaysTotals.fat}">0</span>g F
                    </p>
                    <a href="/form" class="btn btn-primary">Create Your First Meal Plan</a>
                </div>
            </div></div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-6 mb-3"><div class="card neon h-100"><div class="card-body text-center">
            <h4><i class="bi bi-lightning-charge"></i> Quick Add from Meal Plan</h4>
            <p class="text-muted">Log a meal from your saved plans</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickAddModal">Quick Add</button>
        </div></div></div>
        <div class="col-md-6 mb-3"><div class="card neon h-100"><div class="card-body text-center">
            <h4><i class="bi bi-plus-circle"></i> Add Custom Food</h4>
            <p class="text-muted">Manually log any food</p>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#manualAddModal">Manual Entry</button>
        </div></div></div>
    </div>

    <div class="row mb-5"><div class="col-12"><div class="card neon"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Today's Food Log</h3>
            <a href="/food-log/history" class="btn btn-outline-primary btn-sm"><i class="bi bi-calendar"></i> 7-Day History</a>
        </div>
        <div th:if="${todaysFoodLogs == null || todaysFoodLogs.isEmpty()}"><p class="text-muted">No foods logged yet today. Start tracking!</p></div>
        <div th:if="${todaysFoodLogs != null && !todaysFoodLogs.isEmpty()}">
            <table class="table table-dark table-striped">
                <thead><tr><th>Time</th><th>Meal</th><th>Food</th><th>Calories</th><th>Protein</th><th>Carbs</th><th>Fat</th><th>Actions</th></tr></thead>
                <tbody>
                <tr th:each="log : ${todaysFoodLogs}">
                    <td th:text="${#temporals.format(log.timeLogged, 'h:mm a')}">8:00 AM</td>
                    <td th:text="${log.mealName}">Breakfast</td>
                    <td th:text="${log.foodDescription}">3 eggs, oatmeal</td>
                    <td th:text="${log.calories}">0</td>
                    <td th:text="${log.protein + 'g'}">0g</td>
                    <td th:text="${log.carbs + 'g'}">0g</td>
                    <td th:text="${log.fat + 'g'}">0g</td>
                    <td>
                        <form th:action="@{/food-log/delete/{id}(id=${log.id})}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this entry?')"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div></div></div></div>

    <div class="row"><div class="col-12">
        <h3>Your Recent Meal Plans</h3>
        <div th:if="${savedPlans.isEmpty()}"><p class="text-muted">You haven't created any meal plans yet. Get started by creating one!</p></div>
        <div th:if="${!savedPlans.isEmpty()}">
            <table class="table table-dark table-striped">
                <thead><tr><th>Date Created</th><th>Goal</th><th>Calories</th><th>Macros</th><th>Actions</th></tr></thead>
                <tbody>
                <tr th:each="plan : ${savedPlans}">
                    <td th:text="${#temporals.format(plan.createdAt, 'MMM dd, yyyy')}"></td>
                    <td th:text="${plan.fitnessGoal}"></td>
                    <td th:text="${plan.targetCalories + ' cal'}"></td>
                    <td>P: <span th:text="${plan.targetProtein}"></span>g | C: <span th:text="${plan.targetCarbs}"></span>g | F: <span th:text="${plan.targetFat}"></span>g</td>
                    <td><a th:href="@{/plan/{id}(id=${plan.id})}" class="btn btn-neon btn-sm">View</a></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div></div>
</div>

<!-- Quick Add Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content neon">
    <div class="modal-header"><h5 class="modal-title">Quick Add from Meal Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><p class="text-muted">Feature coming soon: Quick-add meals from your saved plans! For now, use Manual Entry.</p></div>
</div></div></div>

<!-- Manual Add Modal -->
<div class="modal fade" id="manualAddModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content neon">
    <div class="modal-header"><h5 class="modal-title">Add Food Entry</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <form action="/food-log/add" method="post">
        <div class="modal-body">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" id="dailyTargetCalories" th:value="${latestPlan != null ? latestPlan.targetCalories : 0}" />

            <!-- Mode Selector -->
            <div class="btn-group w-100 mb-4" role="group">
                <button type="button" class="btn btn-outline-success active" id="suggestedModeBtn" onclick="switchToSuggestedMode()">
                    <i class="bi bi-stars"></i> Suggested (Healthy)
                </button>
                <button type="button" class="btn btn-outline-primary" id="manualModeBtn" onclick="switchToManualMode()">
                    <i class="bi bi-pencil"></i> Manual Input
                </button>
            </div>

            <!-- Suggested Mode Section -->
            <div id="suggestedModeSection">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-lightbulb"></i>
                    We'll suggest a healthy meal that fits your macros. Don't like it? Click <strong>Random</strong> for more ideas!
                </div>
                <div class="card neon mb-3" id="suggestionCard">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Suggested Meal</h6>
                            <button type="button" class="btn btn-sm btn-outline-neon" onclick="getRandomSuggestion()">
                                <i class="bi bi-arrow-repeat"></i> Random
                            </button>
                        </div>
                        <div id="suggestionContent" class="text-muted">Click Random to get a healthy meal suggestion...</div>
                    </div>
                </div>
            </div>

            <!-- Manual Mode Section -->
            <div id="manualModeSection" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">What did you eat?</label>
                    <textarea class="form-control" id="manualFoodDescription" rows="3" placeholder="e.g., Chipotle chicken bowl, Hot Pocket, leftover pizza, protein shake"></textarea>
                    <small class="form-text text-muted">Enter anything - we'll estimate the macros</small>
                </div>
                <button type="button" class="btn btn-primary mb-3" onclick="estimateFromManualInput(event)">
                    <i class="bi bi-calculator"></i> Estimate Macros
                </button>
                <div id="healthierAlternative" class="alert alert-success" style="display: none;">
                    <strong><i class="bi bi-lightbulb"></i> Healthier Alternative:</strong>
                    <p class="mb-0 mt-2" id="healthierAlternativeText"></p>
                    <small class="text-muted">Similar macros, whole food option</small>
                </div>
            </div>

            <!-- Common Section: Meal Name -->
            <div class="mb-3 mt-3"><label class="form-label">Meal Name</label>
                <select class="form-select" name="mealName" required>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Snack">Snack</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <!-- Hidden Food Description to submit -->
            <input type="hidden" id="finalFoodDescription" name="foodDescription" value="Custom food" />

            <!-- Macro Inputs -->
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Calories</label><input type="number" class="form-control" id="calories" name="calories" min="0" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">Protein (g)</label><input type="number" class="form-control" id="protein" name="protein" min="0" required></div></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Carbs (g)</label><input type="number" class="form-control" id="carbs" name="carbs" min="0" required></div>
                <div class="col-md-6 mb-3"><label class="form-label">Fat (g)</label><input type="number" class="form-control" id="fat" name="fat" min="0" required></div></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Add Food</button></div>
    </form>
</div></div></div>
<!-- Food Preferences Modal -->
<div class="modal fade" id="preferencesModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content neon">
    <div class="modal-header"><h5 class="modal-title">My Food Preferences</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <form th:action="@{/preferences/save}" method="post">
        <div class="modal-body">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <p class="text-muted mb-4">Tell us what foods you like, and we'll use them when generating your meal plans. Be as specific or general as you want!</p>
            <div class="mb-4">
                <label class="form-label"><strong>Foods I Like / Want in My Meal Plans</strong></label>
                <textarea class="form-control" name="preferredFoods" rows="5"
                          placeholder="Examples:\n- Proteins: chicken breast, salmon, eggs, ground turkey, protein shakes\n- Carbs: white rice, oats, sweet potato, whole wheat bread\n- Fats: avocado, olive oil, almonds\n- Veggies: broccoli, spinach, peppers\n- Other: Greek yogurt, bananas, protein bars"
                          th:text="${userPreferences?.preferredFoodsText}"></textarea>
                <small class="form-text text-muted">List foods separated by commas. Be specific if you have preferences (e.g., &quot;white rice not brown rice&quot;)</small>
            </div>
            <div class="mb-4">
                <label class="form-label"><strong>Foods to Avoid (Optional)</strong></label>
                <textarea class="form-control" name="avoidedFoods" rows="3"
                          placeholder="Examples: brown rice, quinoa, tofu, fish, mushrooms"
                          th:text="${userPreferences?.avoidedFoodsText}"></textarea>
                <small class="form-text text-muted">Foods you don't like or can't eat (allergies alrea covered in meal plan form)</small>
            </div>
            <div class="mb-4">
                <label class="form-label"><strong>How do you prefer to eat?</strong></label>
                <select class="form-select" name="cookingPreference" th:value="${userPreferences?.cookingPreference}">
                    <option value="mostly-home-cooked">Mostly home-cooked meals</option>
                    <option value="mixed">Mix of home-cooked and eating out</option>
                    <option value="convenience-focused">Convenience-focused (meal prep, frozen, eating out)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="form-label"><strong>Dietary Approach</strong></label>
                <select class="form-select" name="dietaryStyle" th:value="${userPreferences?.dietaryStyle}">
                    <option value="flexible">Flexible - whatever fits my macros</option>
                    <option value="mostly-whole-foods">Mostly whole foods with some processed</option>
                    <option value="clean-eating">Clean eating focused</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Preferences</button>
        </div>
    </form>
 </div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentMode = 'suggested';
function switchToSuggestedMode() {
    currentMode = 'suggested';
    document.getElementById('suggestedModeBtn').classList.add('active');
    document.getElementById('manualModeBtn').classList.remove('active');
    document.getElementById('suggestedModeSection').style.display = 'block';
    document.getElementById('manualModeSection').style.display = 'none';
    const ha = document.getElementById('healthierAlternative');
    if (ha) ha.style.display = 'none';
}
function switchToManualMode() {
    currentMode = 'manual';
    document.getElementById('manualModeBtn').classList.add('active');
    document.getElementById('suggestedModeBtn').classList.remove('active');
    document.getElementById('suggestedModeSection').style.display = 'none';
    document.getElementById('manualModeSection').style.display = 'block';
}
function getMealCalorieTarget() {
    const v = parseInt(document.getElementById('dailyTargetCalories')?.value || '0', 10);
    return (isNaN(v) || v <= 0) ? 500 : Math.round(v / 4);
}
function getRandomSuggestion() {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
    const targetCalories = getMealCalorieTarget();
    fetch('/food-log/random-suggestion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'targetCalories=' + encodeURIComponent(targetCalories)
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        if (data.success) {
            document.getElementById('suggestionContent').innerHTML = `
                <p class="mb-2"><strong>${data.foodDescription}</strong></p>
                <div class="d-flex gap-3">
                    <span class="badge text-bg-primary">${data.calories} cal</span>
                    <span class="badge text-bg-info">${data.protein}g P</span>
                    <span class="badge text-bg-warning text-dark">${data.carbs}g C</span>
                    <span class="badge text-bg-danger">${data.fat}g F</span>
                </div>`;
            document.getElementById('finalFoodDescription').value = data.foodDescription;
            document.getElementById('calories').value = data.calories;
            document.getElementById('protein').value = data.protein;
            document.getElementById('carbs').value = data.carbs;
            document.getElementById('fat').value = data.fat;
        } else {
            showAlert('Could not generate suggestion. Try again.', 'warning');
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showAlert('Error generating suggestion.', 'danger');
    });
}
function estimateFromManualInput(ev) {
    const btn = ev?.target || event.target;
    const desc = document.getElementById('manualFoodDescription').value;
    if (!desc || desc.trim() === '') { showAlert('Please enter a food description first.', 'warning'); return; }
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Estimating...';
    fetch('/food-log/estimate-with-alternative', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'foodDescription=' + encodeURIComponent(desc)
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        if (data.success) {
            document.getElementById('finalFoodDescription').value = desc;
            document.getElementById('calories').value = data.calories;
            document.getElementById('protein').value = data.protein;
            document.getElementById('carbs').value = data.carbs;
            document.getElementById('fat').value = data.fat;
            if (data.healthierAlternative) {
                document.getElementById('healthierAlternativeText').textContent = data.healthierAlternative;
                document.getElementById('healthierAlternative').style.display = 'block';
            }
            showAlert('Macros estimated!', 'success');
        } else {
            showAlert(data.error || 'Could not estimate macros.', 'warning');
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showAlert('Error estimating macros.', 'danger');
    });
}
function estimateMacros() {
    const foodDescription = document.getElementById('foodDescription').value;
    if (!foodDescription || foodDescription.trim() === '') {
        showAlert('Please enter a food description first.', 'warning');
        return;
    }
    const btn = document.getElementById('estimateMacrosBtn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Estimating...';

    fetch('/food-log/estimate-macros', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'foodDescription=' + encodeURIComponent(foodDescription)
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        if (data.success) {
            document.getElementById('calories').value = data.calories;
            document.getElementById('protein').value = data.protein;
            document.getElementById('carbs').value = data.carbs;
            document.getElementById('fat').value = data.fat;
            showAlert('Macros estimated! You can adjust them if needed.', 'success');
        } else {
            showAlert(data.error || "Couldn't estimate macros. Please enter them manually.", 'warning');
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showAlert('Error connecting to server. Please enter macros manually.', 'danger');
    });
}

function showAlert(message, type) {
    const container = document.querySelector('#manualAddModal .modal-body');
    const existing = container.querySelector('.alert');
    if (existing) existing.remove();
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show`;
    el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    container.insertBefore(el, container.firstChild);
    setTimeout(() => el.remove(), 5000);
}
</script>
</body>
</html>












